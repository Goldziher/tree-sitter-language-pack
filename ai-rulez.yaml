$schema: https://github.com/Goldziher/ai-rulez/schema/ai-rules-v2.schema.json
agents: []
commands: []
mcp_servers:
  - args:
      - -y
      - ai-rulez@latest
      - mcp
    command: npx
    description: AI-Rulez MCP server for configuration management
    name: ai-rulez
metadata:
  description: Python library that bundles a comprehensive collection of tree-sitter language parsers as both source distributions and pre-built wheels, providing easy access to multiple programming language parsers for syntax analysis and code manipulation.
  name: tree-sitter-language-pack
  version: 1.0.0
presets:
  - popular
rules:
  - content: All language additions must be registered in sources/language_definitions.json with complete metadata (name, source URL, commit hash). Pin vendor dependencies using scripts/pin_vendors.py before committing. Never commit unpinned language sources.
    name: Tree-sitter Language Definitions
    priority: critical
  - content: Run 'poetry run pytest' before committing. All language bindings must have corresponding tests in tests/ directory. Verify each language can be loaded and basic parsing works.
    name: Testing Requirements
    priority: critical
  - content: Maintain py.typed marker in tree_sitter_language_pack/. Use type hints for all public APIs. Run type checking as part of CI to ensure bindings are properly typed.
    name: Type Safety
    priority: high
  - content: Test both source distribution and wheel builds with 'poetry build' before releases. Verify C extensions compile correctly across platforms. Check MANIFEST.in includes all necessary source files.
    name: Build Verification
    priority: high
  - content: Use Poetry for dependency management (pyproject.toml and uv.lock). Keep tree-sitter core library version pinned and tested. Document Python version support policy (currently 3.10+).
    name: Dependency Management
    priority: medium
  - content: Only include languages with permissive licenses (MIT, Apache 2.0). No GPL-licensed tree-sitter grammars. Verify license compatibility in language_definitions.json before adding new languages.
    name: License Compliance
    priority: high
  - content: Follow conventional commits using 'feat:', 'chore:', 'docs:', 'fix:' prefixes as seen in git history. Keep commits atomic and descriptive for changelog generation.
    name: Commit Convention
    priority: medium
sections:
  - content: |-
      ## Quick Start Development Guide

      ### Prerequisites
      - Python 3.10+
      - C compiler (gcc/clang/MSVC)
      - [uv](https://github.com/astral-sh/uv) package manager

      ### Setup in 4 Steps

      ```bash
      # 1. Clone and navigate
      git clone https://github.com/Goldziher/tree-sitter-language-pack.git
      cd tree-sitter-language-pack

      # 2. Install dependencies
      uv sync --no-install-project

      # 3. Clone language vendor repositories (165+ languages)
      uv run --no-sync scripts/clone_vendors.py

      # 4. Build native extensions
      PROJECT_ROOT=. uv run setup.py build_ext --inplace
      ```

      ### Verify Installation

      ```bash
      # Run all tests
      PROJECT_ROOT=. uv run --no-sync pytest tests

      # Test specific language
      PROJECT_ROOT=. uv run --no-sync pytest tests -k test_can_load_language[python]
      ```

      ### Common Commands

      ```bash
      # Lint and format
      uv run --no-sync ruff check
      uv run --no-sync ruff format

      # Type checking
      uv run --no-sync mypy

      # Build distributions
      PROJECT_ROOT=. uv build  # Creates wheel and sdist in dist/
      ```

      **Note**: The `PROJECT_ROOT=.` prefix is required for build/test commands to locate vendor sources correctly.
    name: Quick Start Development Guide
    priority: high
  - content: |-
      ## Adding a New Language

      ### Method 1: Binary Wheel Language (Recommended)

      Most languages are compiled from source and bundled into the wheel:

      **Step 1**: Edit `sources/language_definitions.json`

      ```json
      {
        "newlang": {
          "repo": "https://github.com/tree-sitter/tree-sitter-newlang",
          "rev": "abc123def456",
          "branch": "main",
          "directory": "src",
          "generate": false
        }
      }
      ```

      - `repo`: GitHub repository URL (required)
      - `rev`: Specific commit hash for reproducibility (required)
      - `branch`: Branch name if not "main" (optional)
      - `directory`: Path to src folder from repo root (optional, defaults to root)
      - `generate`: Set `true` to run `tree-sitter generate` before build (optional)

      **Step 2**: Update type definitions in `tree_sitter_language_pack/__init__.py`

      Add to the `SupportedLanguage` literal type:

      ```python
      SupportedLanguage = Literal[
          "python",
          "rust",
          # ... existing languages ...
          "newlang",  # Add here
      ]
      ```

      **Step 3**: Build and test

      ```bash
      # Clone new language repo
      uv run --no-sync scripts/clone_vendors.py

      # Rebuild native extensions
      PROJECT_ROOT=. uv run setup.py build_ext --inplace

      # Test the language loads correctly
      PROJECT_ROOT=. uv run --no-sync pytest tests -k test_can_load_language[newlang]
      ```

      **Step 4**: Update documentation in `README.md`

      Add to the "Available Languages" list with license info:

      ```markdown
      - [newlang](https://github.com/tree-sitter/tree-sitter-newlang) - MIT License
      ```

      ### Method 2: Pre-installed Dependency

      For languages distributed as separate PyPI packages:

      ```bash
      # Add dependency
      uv add tree-sitter-newlang --no-install-project
      ```

      Then update `InstalledBindings` and `installed_bindings_map` in `tree_sitter_language_pack/__init__.py`.

      ### Updating Language Versions

      ```bash
      # Update all languages to latest commits
      uv run --no-sync scripts/pin_vendors.py

      # Update only languages missing revisions
      uv run --no-sync scripts/pin_vendors.py --only-missing

      # Update specific languages
      uv run --no-sync scripts/pin_vendors.py --languages=python,rust,go
      ```
    name: Adding a New Language
    priority: high
  - content: |-
      ## Architecture Overview

      ### Project Structure

      ```
      tree-sitter-language-pack/
      ├── tree_sitter_language_pack/     # Main Python package
      │   ├── __init__.py                # Public API: get_binding(), get_language(), get_parser()
      │   └── bindings/                  # Runtime binding imports
      ├── sources/
      │   ├── language_definitions.json  # Language metadata (repo, rev, paths)
      │   └── language_extension.c       # C template for building extensions
      ├── scripts/
      │   ├── clone_vendors.py           # Clones language repos from definitions
      │   └── pin_vendors.py             # Updates language revisions
      ├── setup.py                       # Builds C extensions for all languages
      └── vendors/                       # Cloned language repos (gitignored)
      ```

      ### How It Works

      1. **Build Time**: `setup.py` reads `sources/language_definitions.json`, compiles each language's C parser into a Python extension module
      2. **Distribution**: Pre-built wheels contain compiled bindings for all 165+ languages
      3. **Runtime**: `get_language("python")` imports the compiled binding and returns a `tree_sitter.Language` instance

      ### Public API

      The package exposes three main functions in `tree_sitter_language_pack/__init__.py`:

      ```python
      from tree_sitter_language_pack import get_binding, get_language, get_parser

      # Get raw C binding (PyCapsule object)
      binding = get_binding("python")

      # Get tree_sitter.Language instance
      language = get_language("python")

      # Get pre-configured tree_sitter.Parser
      parser = get_parser("python")
      parse_tree = parser.parse(b"print('hello')")
      ```

      ### Language Categories

      - **Binary Wheel Languages**: Compiled from source during wheel build (most languages)
      - **Installed Bindings**: External packages installed as dependencies (referenced in `installed_bindings_map`)

      ### Build System

      - Uses `setuptools` with custom C extension building
      - `MANIFEST.in` ensures `sources/` directory is included in sdist
      - `pyproject.toml` defines metadata and dependencies (managed by `uv`)
      - Native extensions built per-platform during wheel creation

      ### Testing Strategy

      Parametrized tests in `tests/entry_point_test.py` verify:
      - Each language can be loaded via `get_language()`
      - Each language can create a parser via `get_parser()`
      - All 165+ languages are tested automatically
    name: Architecture Overview
    priority: medium
